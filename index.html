<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220; --card:#13182a; --accent:#6ae3ff; --accent2:#7c5cff; --text:#e9efff; --muted:#9fb3c8;
      --border: rgba(255,255,255,.08);
    }
    [data-theme="light"]{
      --bg:#f0f4ff; --card:#ffffff; --accent:#0076ff; --accent2:#5c19ff; --text:#0f1220; --muted:#5f6b75;
      --border: rgba(10,14,26,.1);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Cairo',system-ui;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
    }
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .title{font-size:20px;font-weight:700}
    button{
      appearance:none;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;padding:9px 16px;border-radius:14px;font-weight:700;cursor:pointer;font-family:inherit;
    }
    button.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    .layout{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:16px;}
    .timers{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;}
    .timers.single{justify-content:center;}
    .timers.single .timer-card{width:min(560px,100%);}
    .timers.single .ring{width:260px;}
    .timer-card{
      background:var(--card);border:1px solid var(--border);border-radius:22px;width:360px;
      padding:18px;display:flex;flex-direction:column;gap:14px;box-shadow:0 12px 40px rgba(0,0,0,.1);
      cursor:pointer;transition:.12s ease;
    }
    .timer-card.active{outline:3px solid var(--accent);box-shadow:0 0 16px rgba(106,227,255,.4);}
    .timer-header{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .badge{background:rgba(106,227,255,.12);border:1px solid rgba(106,227,255,.25);border-radius:999px;font-size:12px;padding:4px 10px;color:var(--accent);}
    .inputs-row{display:flex;gap:8px;flex-wrap:wrap;}
    .field{background:rgba(10,14,26,.12);border:1px solid rgba(255,255,255,.02);border-radius:14px;padding:4px 10px 8px;min-width:80px;flex:1;}
    [data-theme="light"] .field{background:rgba(15,18,32,.03);border:1px solid rgba(0,0,0,.03)}
    .field label{font-size:11px;color:var(--muted)}
    .field input,.field select{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-size:16px;font-weight:700;}
    .inline-small{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);flex-wrap:wrap;}
    .inline-small .time-input{background:transparent;border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:3px 6px;color:inherit;}
    .inline-small label{display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap;}
    .small-btn{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04);padding:4px 10px;border-radius:999px;font-size:11px;cursor:pointer;white-space:nowrap;}
    .ring-wrap{display:flex;justify-content:center}
    .ring{position:relative;width:200px;aspect-ratio:1/1;display:grid;place-items:center;}
    .ring .track{position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(26,33,64,.1) 56%,transparent 57%),conic-gradient(#243 0 100%);z-index:1;}
    .ring .progress{position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--accent),var(--accent2) calc(var(--p,0)*1%),transparent 0);-webkit-mask:radial-gradient(circle at 50% 50%,transparent 60%,black 61%);mask:radial-gradient(circle at 50% 50%,transparent 60%,black 61%);filter:drop-shadow(0 0 14px rgba(122,225,255,.4));z-index:2;}
    .time{position:relative;z-index:3;font-variant-numeric:tabular-nums;font-size:28px;font-weight:700;}
    .timer-actions{display:flex;gap:6px;flex-wrap:wrap;}
    .timer-actions button{flex:1;text-align:center;}
    .sidebar{display:flex;flex-direction:column;gap:14px;}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;}
    .panel h2{font-size:15px;margin:0 0 10px}
    .profile-list,.history-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto;}
    .profile-item,.history-item{background:rgba(0,0,0,.05);border:1px solid rgba(255,255,255,.02);border-radius:14px;padding:6px 10px;display:flex;justify-content:space-between;gap:10px;align-items:center;font-size:13px;}
    small{color:var(--muted)}
    .linkish{color:var(--accent);font-size:12px;cursor:pointer}
    @media (max-width:980px){
      .layout{grid-template-columns:1fr;}
      .timers{justify-content:flex-start;}
      .timers.single .timer-card{width:100%;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª</div>
    <div style="display:flex;gap:8px;">
      <button id="add-timer">+ Ù…Ø¤Ù‚Øª Ø¬Ø¯ÙŠØ¯</button>
      <button class="secondary" id="toggle-theme">ÙˆØ¶Ø¹ ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†</button>
    </div>
  </div>

  <div class="layout">
    <div class="timers" id="timers"></div>
    <div class="sidebar">
      <div class="panel">
        <h2>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª</h2>
        <div class="profile-list" id="profiles"></div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <input id="profile-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø©" style="flex:1;border:1px solid var(--border);background:transparent;border-radius:10px;padding:5px 8px;color:var(--text);">
          <input id="profile-mins" type="number" min="1" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚" style="width:90px;border:1px solid var(--border);background:transparent;border-radius:10px;padding:5px 8px;color:var(--text);">
          <button id="save-profile">Ø­ÙØ¸</button>
        </div>
        <small>Ø§Ø®ØªØ± Ù…Ø¤Ù‚Øª Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
      </div>
      <div class="panel">
        <h2>Ø§Ù„Ø³Ø¬Ù„</h2>
        <div class="history-list" id="history"></div>
        <div class="linkish" id="clear-history">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</div>
      </div>
      <div class="panel">
        <h2>Webhook (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h2>
        <input id="webhook-url" placeholder="https://example.com/hook" style="width:100%;border:1px solid var(--border);background:transparent;border-radius:10px;padding:5px 8px;color:var(--text);">
        <small>ÙŠØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ø¤Ù‚Øª</small>
      </div>
    </div>
  </div>

  <script>
    function normalizeDigits(str){if(typeof str!=='string')str=String(str??'');return str.replace(/[Ù -Ù©]/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)).replace(/[Û°-Û¹]/g,d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));}
    function msToParts(ms){const s=Math.max(0,Math.floor(ms/1000));return{h:Math.floor(s/3600),m:Math.floor((s%3600)/60),s:s%60};}
    function formatMs(ms){const p=msToParts(ms);return String(p.h).padStart(2,'0')+":"+String(p.m).padStart(2,'0')+":"+String(p.s).padStart(2,'0');}
    function makeTodayTargetFromHHMM(hhmm){if(!hhmm)return null;const [h,m]=hhmm.split(':').map(x=>parseInt(x,10));if(Number.isNaN(h)||Number.isNaN(m))return null;const now=new Date();return new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0,0);}

    const timersEl=document.getElementById('timers');
    const profilesEl=document.getElementById('profiles');
    const historyEl=document.getElementById('history');
    const webhookInput=document.getElementById('webhook-url');

    let timers=[],profiles=[],history=[],activeTimerId=null;

    (function loadState(){
      const st=JSON.parse(localStorage.getItem('timerDashboard')||'{}');
      profiles=st.profiles||[{name:'Ø¬Ù„Ø³Ø© 25 Ø¯Ù‚ÙŠÙ‚Ø©',minutes:25},{name:'Ø¯ÙˆØ§Ù… 8 Ø³Ø§Ø¹Ø§Øª',minutes:480},{name:'Ø§Ø³ØªØ±Ø§Ø­Ø© 10 Ø¯',minutes:10}];
      history=st.history||[];
      webhookInput.value=st.webhook||'';
      const theme=st.theme||'dark';
      document.documentElement.setAttribute('data-theme',theme);
    })();

    function saveState(){
      localStorage.setItem('timerDashboard',JSON.stringify({
        profiles,history,webhook:webhookInput.value,
        theme:document.documentElement.getAttribute('data-theme')
      }));
    }

    function createTimer(defaultMinutes=60){
      const id='t'+Date.now()+Math.random().toString(16).slice(2,6);
      const totalMs=defaultMinutes*60*1000;
      const timer={id,name:'Ù…Ø¤Ù‚Øª',mode:'countdown',totalMs,remaining:totalMs,running:false,lastTick:null,periodicMinutes:0,muted:false,useStartAt:false,startAt:''};
      timers.push(timer);activeTimerId=id;renderTimers();return timer;
    }

    function renderTimers(){
      timersEl.innerHTML='';
      if(timers.length===1)timersEl.classList.add('single');else timersEl.classList.remove('single');

      timers.forEach(t=>{
        const card=document.createElement('div');
        card.className='timer-card';
        if(t.id===activeTimerId)card.classList.add('active');

        const header=document.createElement('div');
        header.className='timer-header';
        const title=document.createElement('input');
        title.value=t.name;title.style.background='transparent';title.style.border='none';title.style.outline='none';title.style.fontWeight='700';
        title.addEventListener('input',()=>{t.name=title.value;saveState();});
        const badge=document.createElement('span');
        badge.className='badge';
        badge.textContent=t.running?'ÙŠØ¹Ù…Ù„':(t.useStartAt&&t.startAt?`ÙŠÙ†ØªØ¸Ø± ${t.startAt}`:'Ù…ØªÙˆÙ‚Ù');
        header.appendChild(title);header.appendChild(badge);card.appendChild(header);

        const inputsRow=document.createElement('div');inputsRow.className='inputs-row';
        const parts=msToParts(t.totalMs);
        function makeField(lbl,val){
          const f=document.createElement('div');f.className='field';
          const lab=document.createElement('label');lab.textContent=lbl;
          const inp=document.createElement('input');inp.type='number';inp.value=val;
          f.appendChild(lab);f.appendChild(inp);
          return{field:f,input:inp};
        }
        const {field:fH,input:inH}=makeField('Ø§Ù„Ø³Ø§Ø¹Ø§Øª',parts.h);
        const {field:fM,input:inM}=makeField('Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚',parts.m);
        const {field:fS,input:inS}=makeField('Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ',parts.s);
        inputsRow.appendChild(fH);inputsRow.appendChild(fM);inputsRow.appendChild(fS);

        const fMode=document.createElement('div');fMode.className='field';fMode.innerHTML='<label>Ø§Ù„ÙˆØ¶Ø¹</label>';
        const sel=document.createElement('select');sel.innerHTML='<option value="countdown">ØªÙ†Ø§Ø²Ù„ÙŠ</option><option value="countup">ØªØµØ§Ø¹Ø¯ÙŠ</option>';sel.value=t.mode;
        fMode.appendChild(sel);inputsRow.appendChild(fMode);

        const fP=document.createElement('div');fP.className='field';fP.innerHTML='<label>ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ (Ø¯)</label>';
        const inP=document.createElement('input');inP.type='number';inP.value=t.periodicMinutes||'';fP.appendChild(inP);
        inputsRow.appendChild(fP);

        card.appendChild(inputsRow);

        // start row
        const startRow=document.createElement('div');startRow.className='inline-small';
        const labelWrap=document.createElement('label');
        const startChk=document.createElement('input');startChk.type='checkbox';startChk.checked=t.useStartAt;
        const labelText=document.createElement('span');labelText.textContent='Ø§Ø¨Ø¯Ø£ Ø¹Ù†Ø¯';
        labelWrap.appendChild(startChk);labelWrap.appendChild(labelText);
        const startTime=document.createElement('input');startTime.type='time';startTime.className='time-input';startTime.value=t.startAt||'';
        const btnCalc=document.createElement('button');btnCalc.textContent='Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙŠÙˆÙ…';btnCalc.className='small-btn';
        startRow.appendChild(labelWrap);startRow.appendChild(startTime);startRow.appendChild(btnCalc);
        card.appendChild(startRow);

        const ringWrap=document.createElement('div');ringWrap.className='ring-wrap';
        const ring=document.createElement('div');ring.className='ring';
        const track=document.createElement('div');track.className='track';
        const prog=document.createElement('div');prog.className='progress';
        const time=document.createElement('div');time.className='time';

        function updateLocalView(){
          if(t.mode==='countdown'){
            time.textContent=formatMs(t.remaining);
            const pct=t.totalMs?(1-(t.remaining/t.totalMs))*100:0;
            prog.style.setProperty('--p',pct);
          }else{
            time.textContent=formatMs(t.totalMs - t.remaining);
            prog.style.setProperty('--p',0);
          }
          badge.textContent=t.running?'ÙŠØ¹Ù…Ù„':(t.useStartAt&&t.startAt?`ÙŠÙ†ØªØ¸Ø± ${t.startAt}`:'Ù…ØªÙˆÙ‚Ù');
        }
        updateLocalView();

        ring.appendChild(track);ring.appendChild(prog);ring.appendChild(time);ringWrap.appendChild(ring);
        card.appendChild(ringWrap);

        const actions=document.createElement('div');actions.className='timer-actions';
        const btnStart=document.createElement('button');btnStart.textContent='Ø§Ø¨Ø¯Ø£';
        const btnPause=document.createElement('button');btnPause.textContent='Ø¥ÙŠÙ‚Ø§Ù';btnPause.className='secondary';
        const btnResume=document.createElement('button');btnResume.textContent='Ø§Ø³ØªØ¦Ù†Ø§Ù';btnResume.className='secondary';
        const btnReset=document.createElement('button');btnReset.textContent='Ø¥Ø¹Ø§Ø¯Ø©';btnReset.className='secondary';
        const btnMute=document.createElement('button');btnMute.textContent=t.muted?'ğŸ”‡':'ğŸ””';btnMute.className='secondary';
        const btnDelete=document.createElement('button');btnDelete.textContent='ğŸ—‘ï¸ Ø­Ø°Ù';btnDelete.className='secondary';
        actions.append(btnStart,btnPause,btnResume,btnReset,btnMute,btnDelete);card.appendChild(actions);

        function applyInputs(){
          const h=parseInt(normalizeDigits(inH.value)||'0',10);
          const m=parseInt(normalizeDigits(inM.value)||'0',10);
          const s=parseInt(normalizeDigits(inS.value)||'0',10);
          const ms=((h*60*60)+(m*60)+s)*1000;
          t.totalMs=ms;
          if(t.mode==='countdown')t.remaining=ms;else t.remaining=0;
          updateLocalView();saveState();
        }
        inH.addEventListener('input',applyInputs);
        inM.addEventListener('input',applyInputs);
        inS.addEventListener('input',applyInputs);

        sel.addEventListener('change',()=>{
          t.mode=sel.value;
          if(t.mode==='countdown')t.remaining=t.totalMs;else t.remaining=0;
          updateLocalView();saveState();
        });
        inP.addEventListener('change',()=>{
          t.periodicMinutes=parseInt(normalizeDigits(inP.value)||'0',10)||0;
          saveState();
        });

        startChk.addEventListener('change',()=>{
          t.useStartAt=startChk.checked;
          if(t.useStartAt && !t.startAt){
            const now=new Date();now.setMinutes(now.getMinutes()+1);
            const hh=String(now.getHours()).padStart(2,'0');
            const mm=String(now.getMinutes()).padStart(2,'0');
            t.startAt=`${hh}:${mm}`;startTime.value=t.startAt;
          }
          updateLocalView();saveState();
        });
        startTime.addEventListener('change',()=>{
          t.startAt=startTime.value;saveState();updateLocalView();
        });

        // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…
        btnCalc.addEventListener('click',e=>{
          e.stopPropagation();
          const val=startTime.value;
          if(!val){alert('Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø£ÙˆÙ„Ø§Ù‹');return;}
          const target=makeTodayTargetFromHHMM(val);
          if(!target){alert('ÙˆÙ‚Øª ØºÙŠØ± ØµØ§Ù„Ø­');return;}
          const now=new Date();
          let diff=target.getTime()-now.getTime();
          if(diff<0){target.setDate(target.getDate()+1);diff=target.getTime()-now.getTime();}
          // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…Ø¤Ù‚Øª
          t.mode='countdown';
          t.totalMs=diff;
          t.remaining=diff;
          t.running=true;
          t.useStartAt=false;
          t.lastTick=Date.now();

          // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø²Ø± "Ø§Ø¨Ø¯Ø£" Ù…Ø§ ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          const parts=msToParts(diff);
          inH.value=parts.h;
          inM.value=parts.m;
          inS.value=parts.s;

          updateLocalView();
          saveState();
        });

        btnStart.addEventListener('click',e=>{
          e.stopPropagation();
          // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„Ø¢Ù† Ù…Ø­Ø¯Ø«Ø© Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ "Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ")
          applyInputs();
          t.useStartAt=false;
          t.running=true;
          t.lastTick=Date.now();
          activeTimerId=t.id;
          updateLocalView();
          saveState();
        });
        btnPause.addEventListener('click',e=>{
          e.stopPropagation();t.running=false;updateLocalView();saveState();
        });
        btnResume.addEventListener('click',e=>{
          e.stopPropagation();
          if(t.remaining>0 || t.mode==='countup'){
            t.running=true;t.lastTick=Date.now();activeTimerId=t.id;updateLocalView();saveState();
          }
        });
        btnReset.addEventListener('click',e=>{
          e.stopPropagation();
          if(t.mode==='countdown')t.remaining=t.totalMs;else t.remaining=0;
          t.running=false;updateLocalView();saveState();
        });
        btnMute.addEventListener('click',e=>{
          e.stopPropagation();t.muted=!t.muted;btnMute.textContent=t.muted?'ğŸ”‡':'ğŸ””';saveState();
        });
        btnDelete.addEventListener('click',e=>{
          e.stopPropagation();
          if(confirm('ØªØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¤Ù‚ØªØŸ')){
            timers=timers.filter(x=>x.id!==t.id);
            if(activeTimerId===t.id)activeTimerId=timers[0]?.id||null;
            renderTimers();saveState();
          }
        });

        card.addEventListener('click',e=>{
          if(!e.target.closest('button,input,select')){activeTimerId=t.id;renderTimers();}
        });

        timersEl.appendChild(card);
        // Ø±Ø¨Ø· Ø§Ù„ÙƒØ§Ø±Øª Ø¨Ø§Ù„ØªØ§ÙŠÙ…Ø±
        card.dataset.id=t.id;
      });
    }

    function renderProfiles(){
      profilesEl.innerHTML='';
      profiles.forEach((p,idx)=>{
        const div=document.createElement('div');div.className='profile-item';
        div.innerHTML=`<span>${p.name}</span><small>${p.minutes} Ø¯</small>`;
        div.addEventListener('click',()=>{
          if(!activeTimerId)return;
          const t=timers.find(x=>x.id===activeTimerId);if(!t)return;
          t.totalMs=p.minutes*60*1000;t.mode='countdown';t.remaining=t.totalMs;renderTimers();
        });
        const del=document.createElement('span');del.textContent='âœ•';del.style.cursor='pointer';
        del.onclick=e=>{e.stopPropagation();profiles.splice(idx,1);renderProfiles();saveState();};
        div.appendChild(del);profilesEl.appendChild(div);
      });
    }

    function renderHistory(){
      historyEl.innerHTML='';
      history.slice().reverse().forEach(h=>{
        const div=document.createElement('div');div.className='history-item';
        div.innerHTML=`<span>${h.name}</span><small>${h.when}</small>`;
        historyEl.appendChild(div);
      });
    }

    setInterval(()=>{
      const now=Date.now();
      timers.forEach(t=>{
        if(!t.running && t.useStartAt && t.startAt){
          const target=makeTodayTargetFromHHMM(t.startAt);
          if(target && now>=target.getTime()){
            t.running=true;t.lastTick=now;
          }
        }
        if(!t.running)return;
        const elapsed=now-(t.lastTick||now);
        t.lastTick=now;
        if(t.mode==='countdown'){
          t.remaining-=elapsed;
          if(t.remaining<=0){
            t.remaining=0;t.running=false;onTimerFinished(t);
          }
        }else{
          t.remaining+=elapsed;
          if(t.totalMs && t.remaining>=t.totalMs){
            t.running=false;onTimerFinished(t);
          }
        }
      });

      timersEl.querySelectorAll('.timer-card').forEach(card=>{
        const id=card.dataset.id;
        const t=timers.find(x=>x.id===id);
        if(!t)return;
        const timeEl=card.querySelector('.time');
        const progEl=card.querySelector('.progress');
        const badgeEl=card.querySelector('.badge');
        if(t.mode==='countdown'){
          timeEl.textContent=formatMs(t.remaining);
          const pct=t.totalMs?(1-(t.remaining/t.totalMs))*100:0;
          progEl.style.setProperty('--p',pct);
        }else{
          timeEl.textContent=formatMs(t.totalMs - t.remaining);
          progEl.style.setProperty('--p',0);
        }
        badgeEl.textContent=t.running?'ÙŠØ¹Ù…Ù„':(t.useStartAt && t.startAt?`ÙŠÙ†ØªØ¸Ø± ${t.startAt}`:'Ù…ØªÙˆÙ‚Ù');
      });
    },900);

    function onTimerFinished(t){
      history.push({name:t.name||'Ù…Ø¤Ù‚Øª',when:new Date().toLocaleString('ar-SA')});
      saveState();renderHistory();

      if(!t.muted){
        try{
          const ctx=new (window.AudioContext||window.webkitAudioContext)();
          const o=ctx.createOscillator();const g=ctx.createGain();
          o.connect(g);g.connect(ctx.destination);o.type='sine';
          let st=ctx.currentTime;
          o.frequency.setValueAtTime(880,st);
          g.gain.setValueAtTime(0.001,st);
          g.gain.exponentialRampToValueAtTime(0.4,st+0.05);
          g.gain.exponentialRampToValueAtTime(0.001,st+1);
          o.start(st);o.stop(st+1.1);
        }catch(e){}
      }
      if('Notification' in window){
        if(Notification.permission==='granted'){
          new Notification('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø¤Ù‚Øª',{body:t.name||'Ù…Ø¤Ù‚Øª'});
        }else if(Notification.permission!=='denied'){
          Notification.requestPermission();
        }
      }
      const url=webhookInput.value.trim();
      if(url){
        fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({timer:t.name,finishedAt:new Date().toISOString()})}).catch(()=>{});
      }
    }

    setInterval(()=>{
      const now=Date.now();
      timers.forEach(t=>{
        if(!t.running || !t.periodicMinutes)return;
        const key='lastPeriodic_'+t.id;
        const last=t[key]||0;
        if(now-last >= t.periodicMinutes*60*1000){
          t[key]=now;
          if('Notification' in window && Notification.permission==='granted'){
            new Notification('ØªÙ†Ø¨ÙŠÙ‡ Ø¯ÙˆØ±ÙŠ',{body:t.name||'Ù…Ø¤Ù‚Øª'});
          }
        }
      });
    },10000);

    document.getElementById('add-timer').addEventListener('click',()=>{createTimer(60);saveState();});
    document.getElementById('save-profile').addEventListener('click',()=>{
      const name=document.getElementById('profile-name').value.trim();
      const mins=parseInt(normalizeDigits(document.getElementById('profile-mins').value)||'0',10);
      if(!name||!mins)return;
      profiles.push({name,minutes:mins});
      document.getElementById('profile-name').value='';
      document.getElementById('profile-mins').value='';
      renderProfiles();saveState();
    });
    document.getElementById('clear-history').addEventListener('click',()=>{history=[];renderHistory();saveState();});
    document.getElementById('toggle-theme').addEventListener('click',()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'dark';
      const next=cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme',next);saveState();
    });
    webhookInput.addEventListener('change',saveState);

    // init
    if(timers.length===0){createTimer(480);}else{renderTimers();}
    renderProfiles();renderHistory();
  </script>
</body>
</html>
